# âš ï¸ ì´ ë¬¸ì„œëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤

## ğŸ“Œ ìµœì‹  êµ¬í˜„ ê°€ì´ë“œëŠ” ì•„ë˜ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”

ğŸ‘‰ **[ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md](ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md)** - ìµœì¢… ì™„ì„± ê°€ì´ë“œ

---

## ğŸ“‹ ì´ ë¬¸ì„œì˜ ëª©ì 

ì´ ë¬¸ì„œëŠ” **ê°œë°œ ì¤‘ ë°œê²¬ëœ "ë¡œê·¸ì¸ ì‹œ í† í° ì €ì¥ ë¬¸ì œ"** ë¥¼ ë¶„ì„í•˜ê³  í•´ê²° ë°©ë²•ì„ ë¹„êµí•œ ë‚´ìš©ì…ë‹ˆë‹¤.

**í˜„ì¬ ìƒíƒœ**: âœ… ë¬¸ì œ í•´ê²° ì™„ë£Œ
- ìµœì¢… í•´ê²° ë°©ë²•ì€ [ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md](ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md)ì— ë°˜ì˜ë¨

---

## âš ï¸ ë°œê²¬ëœ ë¬¸ì œ (ì´ë¯¸ í•´ê²°ë¨)

### ë¬¸ì œ ìƒí™©
```
1. ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ì•± ì‹¤í–‰
2. FCM í† í° ë°›ìŒ â†’ LocalStorage ì €ì¥
3. g5_is_member = "" (ë¹ˆ ë¬¸ìì—´)
4. ì„œë²„ ì „ì†¡ ì•ˆí•¨ âŒ
5. ë¡œê·¸ì¸ ì™„ë£Œ
6. í˜ì´ì§€ëŠ” ê·¸ëŒ€ë¡œ â†’ g5_is_member ì—¬ì „íˆ ""
7. DOMContentLoaded ì´ë¯¸ ë°œìƒ ì™„ë£Œ
8. í† í° ì €ì¥ ì•ˆë¨ âŒ
```

### ê·¼ë³¸ ì›ì¸
1. **g5_is_memberê°€ ë¬¸ìì—´ë¡œ ì •ì˜ë¨**
   ```javascript
   const g5_is_member = "<?php echo $is_member; ?>"; // "1" ë˜ëŠ” ""
   ```

2. **í˜ì´ì§€ ì´ë™ ì—†ì´ ë¡œê·¸ì¸ ì‹œ ë³€ìˆ˜ ê°±ì‹  ì•ˆë¨**
   - ë¡œê·¸ì¸ ì™„ë£Œí•´ë„ `g5_is_member`ëŠ” í˜ì´ì§€ ë¡œë“œ ì‹œì ì˜ ê°’ ìœ ì§€

3. **DOMContentLoadedëŠ” í•œ ë²ˆë§Œ ì‹¤í–‰**
   - ë¡œê·¸ì¸ í›„ì—ëŠ” ì¬ì‹¤í–‰ ì•ˆë¨

---

## âœ… ìµœì¢… í•´ê²° ë°©ë²•

**[ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md](ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md)** ì˜ **Step 1** ì½”ë“œ ì ìš©

### í•µì‹¬ í•´ê²°ì±…

1. **g5_member_id ë³€ìˆ˜ ì¶”ê°€**
   ```php
   const g5_member_id = "<?php echo isset($member['mb_id'])?$member['mb_id']:''; ?>";
   ```

2. **ì•± ë¸Œë¦¬ì§€ ì½”ë“œ ì¶”ê°€**
   - Android/iOS ê³µí†µ `onTokenReceived()` ì½œë°±
   - DOMContentLoadedì—ì„œ í† í° ìš”ì²­

3. **ì„œë²„ëŠ” ì„¸ì…˜ì—ì„œ mb_id ì¶”ì¶œ**
   ```php
   $mb_id = $member['mb_id']; // ì„¸ì…˜ ê¸°ë°˜ (ì•ˆì „)
   ```

---

## ğŸ“Š ì—¬ëŸ¬ í•´ê²° ë°©ë²• ë¹„êµ (ì°¸ê³ ìš©)

ì•„ë˜ëŠ” ê°œë°œ ì¤‘ ê²€í† í–ˆë˜ ì—¬ëŸ¬ ë°©ë²•ë“¤ì…ë‹ˆë‹¤. ìµœì¢…ì ìœ¼ë¡œ **ë°©ë²• 1 + API ë°©ì‹**ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

### ë°©ë²• 1: ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ URL íŒŒë¼ë¯¸í„° ì¶”ê°€ â­â­â­â­â­

**ì¥ì **: ê°„ë‹¨, ì•ˆì •ì 
**ë‹¨ì **: ë¹„íšŒì› ì €ì¥ ë¶ˆê°€

```php
// login_check.php ìˆ˜ì •
$separator = strpos($link, '?') !== false ? '&' : '?';
$link_with_token_flag = $link . $separator . 'login_success=1';
goto_url($link_with_token_flag);
```

```javascript
// push_notification.js
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const isLoginSuccess = urlParams.get('login_success') === '1';

    if(isLoginSuccess || g5_is_member) {
        const savedToken = localStorage.getItem('fcm_token');
        if(savedToken) {
            savePushTokenToGnuboard(savedToken);
        }
    }
});
```

---

### ë°©ë²• 2: ë¹„íšŒì›ë„ í† í° ì €ì¥ í—ˆìš© â­â­â­â­

**ì¥ì **: ë¹„ë¡œê·¸ì¸â†’ë¡œê·¸ì¸ ìë™ ì—°ê²°
**ë‹¨ì **: ì„œë²„ ì½”ë“œ ìˆ˜ì • í•„ìš”

```php
// ajax.push_token.php ìˆ˜ì •
$mb_id = $member['mb_id'] ?? '';  // ë¹„ë¡œê·¸ì¸ í—ˆìš©

$sql = "INSERT INTO g5_push_tokens
        SET mb_id = '{$mb_id}',
            pt_token = '{$token}',
            pt_platform = '{$platform}',
            pt_datetime = NOW()
        ON DUPLICATE KEY UPDATE
            mb_id = IF('{$mb_id}' != '', '{$mb_id}', mb_id),
            pt_datetime = NOW()";
```

---

### ë°©ë²• 3: API ë°©ì‹ ì‚¬ìš© â­â­â­ (ì±„íƒ)

**ì¥ì **: ë¹„íšŒì› ì§€ì›, CORS ì„¤ì • ì™„ë£Œ, ì™„ì„±ë„ ë†’ìŒ

```javascript
fetch(g5_url + '/api/push_token_save.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        fcm_token: token,
        user_id: g5_member_id || '',
        platform: platform,
        device_id: '',
        app_version: '1.0.0'
    })
});
```

---

### ë°©ë²• 4: ì´ë²¤íŠ¸ í›… í™œìš© â­â­

**ì¥ì **: ë¡œê·¸ì¸ ì§í›„ ì¦‰ì‹œ ì‹¤í–‰
**ë‹¨ì **: êµ¬í˜„ ë³µì¡ë„ ë†’ìŒ

```php
// extend/push_token_login.extend.php
add_event('member_login_check', 'set_token_save_flag', 10, 3);

function set_token_save_flag($mb, $link, $is_social_login) {
    set_session('need_fcm_token_save', '1');
}
```

---

## ğŸ¯ ìµœì¢… ì±„íƒ ë°©ì•ˆ

**ì¡°í•©**: ë°©ë²• 1 (URL íŒŒë¼ë¯¸í„°) + ë°©ë²• 3 (API ë°©ì‹) + ì•± ë¸Œë¦¬ì§€

### ì™œ ì´ ì¡°í•©ì¸ê°€?

1. **ì•± ë¸Œë¦¬ì§€**
   - Android/iOSì—ì„œ í† í° ìš”ì²­
   - `onTokenReceived()` ì½œë°± í†µì¼

2. **API ë°©ì‹**
   - ë¹„íšŒì›ë„ ì €ì¥ ê°€ëŠ¥
   - ë¡œê·¸ì¸ ì‹œ ìë™ mb_id ì—°ê²°

3. **ì„œë²„ ì„¸ì…˜ ê¸°ë°˜**
   - `$member['mb_id']` ì‚¬ìš©
   - í´ë¼ì´ì–¸íŠ¸ ì¡°ì‘ ë¶ˆê°€ (ë³´ì•ˆ)

---

## ğŸ“š ì°¸ê³  ì‚¬í•­

### í˜„ì¬ ì½”ë“œ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ head.sub.php                         â”‚
â”‚ - g5_member_id ì •ì˜                  â”‚
â”‚ - onTokenReceived() ì½œë°±             â”‚
â”‚ - Android/iOS í† í° ìš”ì²­              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ push_notification.js                 â”‚
â”‚ - receiveFCMToken()                  â”‚
â”‚ - savePushTokenToGnuboard()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ajax.push_token.php                  â”‚
â”‚ - ì„¸ì…˜ì—ì„œ mb_id ì¶”ì¶œ                â”‚
â”‚ - g5_push_tokens í…Œì´ë¸”ì— ì €ì¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í…Œì´ë¸” êµ¬ì¡°

```sql
g5_push_tokens
â”œâ”€ pt_id (PK)
â”œâ”€ mb_id (íšŒì›ID) â† ì„¸ì…˜ì—ì„œ ìë™ ì¶”ì¶œ
â”œâ”€ pt_token (FCM í† í°, UNIQUE)
â”œâ”€ pt_platform (android/ios)
â””â”€ pt_datetime
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **[ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md](ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md)** - ìµœì¢… êµ¬í˜„ ê°€ì´ë“œ (ë©”ì¸)
- **[bbs/ajax.push_token.php](bbs/ajax.push_token.php)** - í† í° ì €ì¥ API
- **[js/push_notification.js](js/push_notification.js)** - í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬
- **[theme/rb.basic/head.sub.php](theme/rb.basic/head.sub.php)** - ì•± ë¸Œë¦¬ì§€ ì½”ë“œ

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë¬¸ì œ í•´ê²° ì™„ë£Œ
- [x] g5_member_id ë³€ìˆ˜ ì¶”ê°€
- [x] ì•± ë¸Œë¦¬ì§€ ì½”ë“œ ì‘ì„±
- [x] Android/iOS ê³µí†µ ì½œë°±
- [x] ì„¸ì…˜ ê¸°ë°˜ mb_id ì €ì¥
- [x] í† í° ì¤‘ë³µ ì²˜ë¦¬

### í…ŒìŠ¤íŠ¸ í•„ìš”
- [ ] ë¹„ë¡œê·¸ì¸ â†’ ë¡œê·¸ì¸ ì‹œë‚˜ë¦¬ì˜¤
- [ ] í† í° ì¤‘ë³µ ì²˜ë¦¬
- [ ] Android ì•± ì—°ë™
- [ ] iOS ì•± ì—°ë™

---

**ë‹¤ì‹œ í•œ ë²ˆ ê°•ì¡°**: ì‹¤ì œ êµ¬í˜„ì€ **[ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md](ì•Œë¦¼_ê¸°ì¡´_ì„¸íŒ…ë¶„ì„ë°ë°©ë²•.md)** ë¥¼ ì°¸ê³ í•˜ì„¸ìš”!
