# ê·¸ëˆ„ë³´ë“œ ë¦¬ë¹Œë” í‘¸ì‹œ ì•Œë¦¼ ì‹œìŠ¤í…œ - ìµœì¢… êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ìµœì¢… êµ¬í˜„ ì™„ë£Œ ìƒíƒœ](#1-ìµœì¢…-êµ¬í˜„-ì™„ë£Œ-ìƒíƒœ)
2. [ì•± ì—°ë™ êµ¬í˜„ ë°©ë²•](#2-ì•±-ì—°ë™-êµ¬í˜„-ë°©ë²•)
3. [í…Œì´ë¸” êµ¬ì¡° ë° ì €ì¥ í™•ì¸](#3-í…Œì´ë¸”-êµ¬ì¡°-ë°-ì €ì¥-í™•ì¸)
4. [ê²Œì‹œíŒ ì•Œë¦¼ ì‹œìŠ¤í…œ](#4-ê²Œì‹œíŒ-ì•Œë¦¼-ì‹œìŠ¤í…œ)
5. [ê´€ë¦¬ì ê¸°ëŠ¥](#5-ê´€ë¦¬ì-ê¸°ëŠ¥)
6. [í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸](#6-í…ŒìŠ¤íŠ¸-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## 1. ìµœì¢… êµ¬í˜„ ì™„ë£Œ ìƒíƒœ

### âœ… ì„œë²„ ì¸¡ êµ¬í˜„ ì™„ë£Œ
- âœ… FCM í† í° ì €ì¥ API ([bbs/ajax.push_token.php](bbs/ajax.push_token.php))
- âœ… í† í° ìˆ˜ì‹  JavaScript ([js/push_notification.js](js/push_notification.js))
- âœ… êµ¬ë… ê¸°ë°˜ ì•Œë¦¼ ì‹œìŠ¤í…œ ([extend/rb_subscribe.extend.php](extend/rb_subscribe.extend.php))
- âœ… ê´€ë¦¬ì í‘¸ì‹œ ë°œì†¡ í˜ì´ì§€ ([adm/push_send.php](adm/push_send.php))
- âœ… íšŒì› ID ìë™ ì €ì¥ (ì„¸ì…˜ ê¸°ë°˜)

### âš ï¸ ì•± ì¸¡ êµ¬í˜„ í•„ìš”
- ğŸ“± Android: FCM í† í° â†’ WebView ì „ë‹¬
- ğŸ“± iOS: FCM í† í° â†’ WKWebView ì „ë‹¬

---

## 2. ì•± ì—°ë™ êµ¬í˜„ ë°©ë²•

### ğŸ“ Step 1: head.sub.phpì— ì•± ë¸Œë¦¬ì§€ ì½”ë“œ ì¶”ê°€

**íŒŒì¼**: `theme/rb.basic/head.sub.php`
**ìœ„ì¹˜**: `<script>` íƒœê·¸ ë‚´ë¶€ (ë¼ì¸ 145 ì´í›„)

```php
<script>
// ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì „ì—­ë³€ìˆ˜ ì„ ì–¸
const g5_url       = "<?php echo G5_URL ?>";
const g5_bbs_url   = "<?php echo G5_BBS_URL ?>";
const g5_is_member = "<?php echo isset($is_member)?$is_member:''; ?>";
const g5_is_admin  = "<?php echo isset($is_admin)?$is_admin:''; ?>";
const g5_is_mobile = "<?php echo G5_IS_MOBILE ?>";
const g5_bo_table  = "<?php echo isset($bo_table)?$bo_table:''; ?>";
const g5_sca       = "<?php echo isset($sca)?$sca:''; ?>";
const g5_editor    = "<?php echo ($config['cf_editor'] && $board['bo_use_dhtml_editor'])?$config['cf_editor']:''; ?>";
const g5_cookie_domain = "<?php echo G5_COOKIE_DOMAIN ?>";
const g5_member_id = "<?php echo isset($member['mb_id'])?$member['mb_id']:''; ?>"; // â† ì´ ì¤„ ì¶”ê°€

<?php if (defined('G5_USE_SHOP') && G5_USE_SHOP) { ?>
const g5_theme_shop_url = "<?php echo G5_THEME_SHOP_URL; ?>";
const g5_shop_url = "<?php echo G5_SHOP_URL; ?>";
<?php } ?>
<?php if(defined('G5_IS_ADMIN')) { ?>
const g5_admin_url = "<?php echo G5_ADMIN_URL; ?>";
<?php } ?>

/**
 * ========================================
 * ì•± ì—°ë™: FCM í† í° ë¸Œë¦¬ì§€ (ì¶”ê°€)
 * ========================================
 */

/**
 * ë„¤ì´í‹°ë¸Œ ê³µí†µ ì½œë°±
 * Android / iOS ëª¨ë‘ ì—¬ê¸°ë¡œ í† í°ì„ ì „ë‹¬
 */
function onTokenReceived(token) {
    if (!token) return;

    console.log('[ì•± ë¸Œë¦¬ì§€] FCM Token ìˆ˜ì‹ :', token);

    // ê·¸ëˆ„ë³´ë“œ í‘œì¤€ ì§„ì…ì  ì¬ì‚¬ìš©
    if (window.receiveFCMToken) {
        window.receiveFCMToken(token);
    } else {
        // í˜¹ì‹œ ì•„ì§ ë¡œë“œ ì „ì´ë©´ ë¡œì»¬ì—ë§Œ ì €ì¥
        console.warn('[ì•± ë¸Œë¦¬ì§€] receiveFCMToken í•¨ìˆ˜ ì•„ì§ ë¡œë“œ ì•ˆë¨, localStorageë§Œ ì €ì¥');
        localStorage.setItem('fcm_token', token);
    }
}

/**
 * í˜ì´ì§€ ë¡œë“œ í›„ í† í° ìš”ì²­
 */
document.addEventListener('DOMContentLoaded', function () {
    console.log('[ì•± ë¸Œë¦¬ì§€] DOMContentLoaded - í† í° ìš”ì²­ ì‹œì‘');

    // Android
    if (window.Android && typeof Android.requestToken === 'function') {
        console.log('[ì•± ë¸Œë¦¬ì§€] Android ë¸Œë¦¬ì§€ ê°ì§€ - requestToken() í˜¸ì¶œ');
        Android.requestToken();
    } else {
        console.log('[ì•± ë¸Œë¦¬ì§€] Android ë¸Œë¦¬ì§€ ì—†ìŒ');
    }

    // iOS
    if (
        window.webkit &&
        window.webkit.messageHandlers &&
        window.webkit.messageHandlers.invokeAction
    ) {
        console.log('[ì•± ë¸Œë¦¬ì§€] iOS ë¸Œë¦¬ì§€ ê°ì§€ - getToken ìš”ì²­');
        window.webkit.messageHandlers.invokeAction.postMessage('getToken');
    } else {
        console.log('[ì•± ë¸Œë¦¬ì§€] iOS ë¸Œë¦¬ì§€ ì—†ìŒ');
    }
});
</script>
```

### ğŸ“ Step 2: Android ì•± êµ¬í˜„ (Kotlin)

```kotlin
// MainActivity.kt ë˜ëŠ” BaseWebViewActivity.kt
class MainActivity : AppCompatActivity() {

    private lateinit var webView: WebView

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // WebView ì„¤ì •
        webView = findViewById(R.id.webView)
        webView.settings.apply {
            javaScriptEnabled = true
            domStorageEnabled = true
        }

        // JavaScript ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€
        webView.addJavascriptInterface(WebAppInterface(this), "Android")

        // ì›¹ í˜ì´ì§€ ë¡œë“œ
        webView.loadUrl("https://yourdomain.com")
    }

    // JavaScript ì¸í„°í˜ì´ìŠ¤
    inner class WebAppInterface(private val context: Context) {

        @JavascriptInterface
        fun requestToken() {
            // FCM í† í° ê°€ì ¸ì˜¤ê¸°
            FirebaseMessaging.getInstance().token.addOnSuccessListener { token ->
                Log.d("FCM", "Token: $token")

                // ì›¹ë·°ë¡œ í† í° ì „ë‹¬ (ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰)
                runOnUiThread {
                    webView.evaluateJavascript(
                        "onTokenReceived('$token')",
                        null
                    )
                }
            }.addOnFailureListener { e ->
                Log.e("FCM", "Failed to get token", e)
            }
        }
    }
}
```

**build.gradle ì˜ì¡´ì„± ì¶”ê°€:**
```gradle
dependencies {
    // Firebase Cloud Messaging
    implementation 'com.google.firebase:firebase-messaging:23.4.0'
    implementation 'com.google.firebase:firebase-analytics:21.5.0'
}
```

### ğŸ“ Step 3: iOS ì•± êµ¬í˜„ (Swift)

```swift
// ViewController.swift
import UIKit
import WebKit
import FirebaseMessaging

class ViewController: UIViewController, WKScriptMessageHandler, WKNavigationDelegate {

    var webView: WKWebView!

    override func viewDidLoad() {
        super.viewDidLoad()

        // WKWebView ì„¤ì •
        let config = WKWebViewConfiguration()
        let userContentController = WKUserContentController()

        // JavaScript ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ë“±ë¡
        userContentController.add(self, name: "invokeAction")
        config.userContentController = userContentController

        webView = WKWebView(frame: view.bounds, configuration: config)
        webView.navigationDelegate = self
        view.addSubview(webView)

        // ì›¹ í˜ì´ì§€ ë¡œë“œ
        if let url = URL(string: "https://yourdomain.com") {
            webView.load(URLRequest(url: url))
        }

        // FCM í† í° ê°±ì‹  ë¦¬ìŠ¤ë„ˆ
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(tokenRefreshNotification),
            name: Notification.Name.MessagingRegistrationTokenRefreshed,
            object: nil
        )
    }

    // JavaScriptì—ì„œ í˜¸ì¶œí•˜ëŠ” ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
    func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
        if message.name == "invokeAction", let action = message.body as? String {
            if action == "getToken" {
                sendTokenToWebView()
            }
        }
    }

    // FCM í† í°ì„ ì›¹ë·°ë¡œ ì „ë‹¬
    func sendTokenToWebView() {
        Messaging.messaging().token { token, error in
            if let error = error {
                print("Error fetching FCM token: \(error)")
            } else if let token = token {
                print("FCM Token: \(token)")

                // í† í° ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                let escapedToken = token
                    .replacingOccurrences(of: "\\", with: "\\\\")
                    .replacingOccurrences(of: "'", with: "\\'")

                // ì›¹ë·°ë¡œ í† í° ì „ë‹¬
                let script = "onTokenReceived('\(escapedToken)')"
                self.webView.evaluateJavaScript(script) { result, error in
                    if let error = error {
                        print("Error sending token to WebView: \(error)")
                    } else {
                        print("Token sent to WebView successfully")
                    }
                }
            }
        }
    }

    // FCM í† í° ê°±ì‹  ì‹œ í˜¸ì¶œ
    @objc func tokenRefreshNotification() {
        sendTokenToWebView()
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ
    func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
        print("Page loaded")
        // í•„ìš”ì‹œ í† í° ì¬ì „ì†¡
        sendTokenToWebView()
    }
}
```

**Podfile ì˜ì¡´ì„± ì¶”ê°€:**
```ruby
pod 'Firebase/Messaging'
pod 'Firebase/Analytics'
```

---

## 3. í…Œì´ë¸” êµ¬ì¡° ë° ì €ì¥ í™•ì¸

### ğŸ“Š DB í…Œì´ë¸”: g5_push_tokens

```sql
CREATE TABLE `g5_push_tokens` (
    `pt_id` int(11) NOT NULL AUTO_INCREMENT,
    `mb_id` varchar(20) NOT NULL DEFAULT '',           -- âœ… íšŒì› ID ì €ì¥ë¨
    `pt_token` varchar(500) NOT NULL,                  -- FCM í† í°
    `pt_platform` varchar(10) NOT NULL DEFAULT '',     -- android/ios
    `pt_device_id` varchar(100) NOT NULL DEFAULT '',
    `pt_app_version` varchar(20) NOT NULL DEFAULT '',
    `pt_device_info` text,
    `pt_datetime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `pt_update_datetime` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
    `pt_use` tinyint(4) NOT NULL DEFAULT '1',
    PRIMARY KEY (`pt_id`),
    UNIQUE KEY `pt_token` (`pt_token`),                -- í† í° ì¤‘ë³µ ë°©ì§€
    KEY `mb_id` (`mb_id`),
    KEY `pt_device_id` (`pt_device_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

### âœ… íšŒì› ID ì €ì¥ í™•ì¸

**[bbs/ajax.push_token.php:23-31](bbs/ajax.push_token.php:23-31)**
```php
// ì„¸ì…˜ì—ì„œ íšŒì› ID ìë™ ì¶”ì¶œ
$mb_id = $member['mb_id'];  // â† ë¡œê·¸ì¸ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜´

$sql = "INSERT INTO g5_push_tokens
        SET mb_id = '{$mb_id}',        // â† ì—¬ê¸° ì €ì¥
            pt_token = '{$token}',
            pt_platform = '{$platform}',
            pt_datetime = NOW()
        ON DUPLICATE KEY UPDATE
            mb_id = '{$mb_id}',        // â† ì—…ë°ì´íŠ¸ ì‹œì—ë„ ì €ì¥
            pt_datetime = NOW()";
```

**ì¤‘ìš”**: JavaScriptì—ì„œ `user_id`ë¥¼ ì „ì†¡í•˜ì§€ë§Œ, **ì„œë²„ëŠ” ì„¸ì…˜ì˜ `$member['mb_id']`ë§Œ ì‚¬ìš©**í•©ë‹ˆë‹¤.
â†’ í´ë¼ì´ì–¸íŠ¸ ì¡°ì‘ ë¶ˆê°€ëŠ¥ (ë³´ì•ˆ ê°•í™”)

---

## 4. ê²Œì‹œíŒ ì•Œë¦¼ ì‹œìŠ¤í…œ

### âœ… êµ¬ë… ê¸°ë°˜ ì•Œë¦¼ (ì´ë¯¸ êµ¬í˜„ë¨)

**íŒŒì¼**: [extend/rb_subscribe.extend.php](extend/rb_subscribe.extend.php)

#### ë™ì‘ ë°©ì‹
```php
// ìƒˆê¸€ ì‘ì„± ì‹œ ìë™ ì‹¤í–‰
add_event('write_update_after', 'sb_send', G5_HOOK_DEFAULT_PRIORITY, 5);

function sb_send($board, $wr_id, $w, $qstr, $redirect_url) {
    // 1. ìƒˆê¸€ë§Œ ì²˜ë¦¬ ($w == '')
    // 2. ì‘ì„±ìì˜ êµ¬ë…ì ì¡°íšŒ
    // 3. êµ¬ë…ìì—ê²Œ ë©”ëª¨ + FCM í‘¸ì‹œ ë°œì†¡
}
```

#### ì•Œë¦¼ ë°œì†¡ ì¡°ê±´
- âœ… ìƒˆê¸€ ì‘ì„± ì‹œ (`$w == ''`)
- âœ… êµ¬ë…ìê°€ í‘¸ì‹œ í™œì„±í™” (`sb_push = '1'`)
- âœ… FCM í† í° ë“±ë¡ë¨

#### ì•Œë¦¼ ë‚´ìš©
```php
$title = $writer['mb_nick']. 'ë‹˜ ê»˜ì„œ '.$bbs_name.'ì— ìƒˆê¸€ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.';
$link_url = G5_BBS_URL.'/board.php?bo_table='.$bbs_id.'&wr_id='.$wr_id;
```

### âš ï¸ ë¯¸êµ¬í˜„ ê¸°ëŠ¥
- ëŒ“ê¸€ ì‘ì„± ì‹œ ì•Œë¦¼
- ê²Œì‹œê¸€ ìˆ˜ì • ì‹œ ì•Œë¦¼

---

## 5. ê´€ë¦¬ì ê¸°ëŠ¥

### ğŸ“ í‘¸ì‹œ ë°œì†¡ ê´€ë¦¬ í˜ì´ì§€

**ê²½ë¡œ**: ê´€ë¦¬ì > ì•± ê´€ë¦¬ > í‘¸ì‹œ ë°œì†¡
**íŒŒì¼**: [adm/push_send.php](adm/push_send.php)

#### ê¸°ëŠ¥
1. **í†µê³„ ëŒ€ì‹œë³´ë“œ**
   - ë“±ë¡ íšŒì› ìˆ˜
   - ì „ì²´ í† í° ìˆ˜
   - Android/iOS í”Œë«í¼ë³„ í†µê³„

2. **í‘¸ì‹œ ë°œì†¡**
   - ì „ì²´ ë°œì†¡
   - ì„ íƒ ë°œì†¡ (íŠ¹ì • íšŒì›)
   - í…ŒìŠ¤íŠ¸ ëª¨ë“œ

3. **ë°œì†¡ ì´ë ¥**
   - g5_push_tokens_log í…Œì´ë¸”ì— ì €ì¥
   - ìµœê·¼ 10ê±´ í‘œì‹œ

### âš ï¸ ì‹¤ì œ FCM ë°œì†¡ êµ¬í˜„ í•„ìš”

í˜„ì¬ëŠ” ë°œì†¡ í•¨ìˆ˜ê°€ ì£¼ì„ ì²˜ë¦¬ë˜ì–´ ìˆìŒ:
```php
// ë¼ì¸ 48-53
// $fcm_result = send_fcm_push($row['pt_token'], $title, $message);
```

â†’ `send_fcm_push()` í•¨ìˆ˜ êµ¬í˜„ í•„ìš”

---

## 6. í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ğŸ“± ì•± ì—°ë™ í…ŒìŠ¤íŠ¸

#### Android
- [ ] WebViewì—ì„œ JavaScript í™œì„±í™” í™•ì¸
- [ ] `Android` ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€ í™•ì¸
- [ ] FCM í† í° ìƒì„± í™•ì¸
- [ ] `onTokenReceived()` í˜¸ì¶œ í™•ì¸
- [ ] ì½˜ì†”ì—ì„œ í† í° ìˆ˜ì‹  ë¡œê·¸ í™•ì¸

#### iOS
- [ ] WKWebView ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ë“±ë¡ í™•ì¸
- [ ] FCM í† í° ìƒì„± í™•ì¸
- [ ] `onTokenReceived()` í˜¸ì¶œ í™•ì¸
- [ ] í† í° ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í™•ì¸

### ğŸ—„ï¸ í† í° ì €ì¥ í…ŒìŠ¤íŠ¸

#### ë¹„ë¡œê·¸ì¸ ìƒíƒœ
- [ ] ì•± ì‹¤í–‰
- [ ] FCM í† í° ìƒì„±
- [ ] localStorageì— í† í° ì €ì¥ í™•ì¸
- [ ] ì„œë²„ ì „ì†¡ ì‹¤íŒ¨ í™•ì¸ (ë¡œê·¸ì¸ í•„ìš”)

#### ë¡œê·¸ì¸ í›„
- [ ] ë¡œê·¸ì¸ ì™„ë£Œ
- [ ] í˜ì´ì§€ ì´ë™ ë˜ëŠ” ìƒˆë¡œê³ ì¹¨
- [ ] localStorage í† í° ì„œë²„ë¡œ ì „ì†¡
- [ ] DB í™•ì¸: `g5_push_tokens` í…Œì´ë¸”
  ```sql
  SELECT * FROM g5_push_tokens WHERE mb_id = 'testuser';
  ```
- [ ] mb_id ì €ì¥ í™•ì¸ âœ…
- [ ] pt_token ì €ì¥ í™•ì¸ âœ…
- [ ] pt_platform ì €ì¥ í™•ì¸ âœ…

#### í† í° ì¤‘ë³µ ì²˜ë¦¬
- [ ] ê°™ì€ í† í°ìœ¼ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸
- [ ] `ON DUPLICATE KEY UPDATE` ë™ì‘ í™•ì¸
- [ ] pt_datetime ì—…ë°ì´íŠ¸ í™•ì¸

### ğŸ“¬ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸

#### êµ¬ë… ì•Œë¦¼
- [ ] íšŒì› Aê°€ íšŒì› Bë¥¼ êµ¬ë…
- [ ] íšŒì› Bê°€ ìƒˆê¸€ ì‘ì„±
- [ ] íšŒì› Aì—ê²Œ ë©”ëª¨ ì „ì†¡ í™•ì¸
- [ ] FCM í‘¸ì‹œ ë°œì†¡ í™•ì¸ (send_fcm_push êµ¬í˜„ í›„)

#### ê´€ë¦¬ì ë°œì†¡
- [ ] ê´€ë¦¬ì í˜ì´ì§€ ì ‘ì†
- [ ] í† í° í†µê³„ í™•ì¸
- [ ] ì „ì²´ ë°œì†¡ í…ŒìŠ¤íŠ¸
- [ ] ì„ íƒ ë°œì†¡ í…ŒìŠ¤íŠ¸

---

## 7. ë™ì‘ íë¦„ ìš”ì•½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ì•± ì‹œì‘                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ FCM í† í° ìƒì„±          â”‚
            â”‚ (Firebase SDK)         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                â”‚
        â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Android       â”‚              â”‚ iOS            â”‚
â”‚ requestToken()â”‚              â”‚ getToken       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ onTokenReceived(token) â”‚
            â”‚ (ë¸Œë¦¬ì§€ ì½œë°±)           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ receiveFCMToken(token) â”‚
            â”‚ (ê·¸ëˆ„ë³´ë“œ ì§„ì…ì )       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                â”‚
        â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ localStorage   â”‚              â”‚ ë¡œê·¸ì¸ ì²´í¬     â”‚
â”‚ ì €ì¥           â”‚              â”‚ g5_is_member   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ savePushToken         â”‚
                            â”‚ ToGnuboard(token)     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ ajax.push_token.php   â”‚
                            â”‚ POST ì „ì†¡              â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ ì„¸ì…˜ì—ì„œ mb_id ì¶”ì¶œ    â”‚
                            â”‚ $member['mb_id']      â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ DB ì €ì¥                â”‚
                            â”‚ g5_push_tokens        â”‚
                            â”‚ - mb_id âœ…            â”‚
                            â”‚ - pt_token âœ…         â”‚
                            â”‚ - pt_platform âœ…      â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ì¶”ê°€ ê°œì„  ì‚¬í•­ (ì„ íƒ)

### ğŸ”§ ë¹„ë¡œê·¸ì¸ í† í° ì €ì¥ ì§€ì›

í˜„ì¬ëŠ” ë¡œê·¸ì¸ í•„ìˆ˜ì¸ë°, ë¹„ë¡œê·¸ì¸ë„ ì§€ì›í•˜ë ¤ë©´:

**[bbs/ajax.push_token.php](bbs/ajax.push_token.php) ìˆ˜ì •**
```php
// ê¸°ì¡´ (ë¡œê·¸ì¸ í•„ìˆ˜)
if(!$member['mb_id']) {
    die(json_encode(['success' => false, 'message' => 'ë¡œê·¸ì¸ í•„ìš”']));
}

// ìˆ˜ì • (ë¹„ë¡œê·¸ì¸ í—ˆìš©)
$mb_id = $member['mb_id'] ?? '';  // ë¹„ë¡œê·¸ì¸ì€ ë¹ˆ ê°’

// INSERT ì‹œ mb_id ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸
$sql = "INSERT INTO g5_push_tokens
        SET mb_id = '{$mb_id}',
            pt_token = '{$token}',
            pt_platform = '{$platform}',
            pt_datetime = NOW()
        ON DUPLICATE KEY UPDATE
            mb_id = IF('{$mb_id}' != '', '{$mb_id}', mb_id),  -- ë¡œê·¸ì¸ ì‹œë§Œ ì—…ë°ì´íŠ¸
            pt_datetime = NOW()";
```

**ì¥ì **:
- ë¹„ë¡œê·¸ì¸ â†’ ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ mb_id ì—°ê²°
- ì•± ì„¤ì¹˜ í›„ ì¦‰ì‹œ í† í° ì €ì¥ ê°€ëŠ¥

### ğŸ”„ í† í° ê°±ì‹  ì£¼ê¸°ì  ì²´í¬

```javascript
// push_notification.jsì— ì¶”ê°€
setInterval(function() {
    if(typeof g5_is_member !== 'undefined' && g5_is_member) {
        const savedToken = localStorage.getItem('fcm_token');
        if(savedToken) {
            savePushTokenToGnuboard(savedToken);
        }
    }
}, 1000 * 60 * 30); // 30ë¶„ë§ˆë‹¤ ì¬ì „ì†¡
```

---

## ğŸ“ ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­
- [x] ì„œë²„: ajax.push_token.php (ì™„ë£Œ)
- [x] ì„œë²„: push_notification.js (ì™„ë£Œ)
- [x] ì„œë²„: ì•± ë¸Œë¦¬ì§€ ì½”ë“œ (head.sub.phpì— ì¶”ê°€)
- [ ] ì•±: Android FCM í† í° â†’ WebView ì „ë‹¬
- [ ] ì•±: iOS FCM í† í° â†’ WKWebView ì „ë‹¬
- [ ] í…ŒìŠ¤íŠ¸: í† í° ì €ì¥ í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸: mb_id ì €ì¥ í™•ì¸

### ğŸ”§ ì„ íƒ êµ¬í˜„ ì‚¬í•­
- [ ] ë¹„ë¡œê·¸ì¸ í† í° ì €ì¥ ì§€ì›
- [ ] send_fcm_push() ì‹¤ì œ ë°œì†¡ í•¨ìˆ˜ êµ¬í˜„
- [ ] ëŒ“ê¸€ ì‘ì„± ì‹œ ì•Œë¦¼ ì¶”ê°€
- [ ] í† í° ê°±ì‹  ì£¼ê¸°ì  ì²´í¬

---

## ğŸ¯ ê²°ë¡ 

**í˜„ì¬ ìƒíƒœ**: ì„œë²„ ì¸¡ 95% ì™„ì„±, ì•± ì¸¡ êµ¬í˜„ í•„ìš”

**ì™„ì„±ê¹Œì§€ í•„ìš”í•œ ì‘ì—…**:
1. âœ… head.sub.phpì— ì•± ë¸Œë¦¬ì§€ ì½”ë“œ ì¶”ê°€ (ìœ„ ì½”ë“œ ë³µë¶™)
2. ğŸ“± Android ì•±ì—ì„œ `Android.requestToken()` êµ¬í˜„
3. ğŸ“± iOS ì•±ì—ì„œ FCM í† í° â†’ WebView ì „ë‹¬ êµ¬í˜„
4. ğŸ§ª í…ŒìŠ¤íŠ¸ ì§„í–‰

**ì¶”ê°€ ì½”ë“œ ì‘ì„± ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥!**
