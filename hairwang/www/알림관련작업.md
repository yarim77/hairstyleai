# 📱 알림 관련 작업 이력

> 모든 푸시 알림 관련 작업을 상세하게 기록합니다.

---

## 📅 2025-01-03 (금)

### ✅ Step 1: head.sub.php에 앱 브리지 코드 추가

#### 📍 작업 파일
- **파일명**: `theme/rb.basic/head.sub.php`
- **경로**: `F:\0push_project_www\hairwang\www\theme\rb.basic\head.sub.php`

#### 📝 작업 내용

##### 1️⃣ 전역 변수 추가

**위치**: 라인 165
**작업**: 회원 ID 전역 변수 추가

```javascript
// ✅ 추가된 코드
const g5_member_id = "<?php echo isset($member['mb_id'])?$member['mb_id']:''; ?>";
```

**목적**:
- `push_notification.js`에서 사용자 식별을 위해 필요
- 세션에서 추출한 회원 ID (로그인 상태에서만 값 존재)
- 서버 측 세션 기반이므로 클라이언트 조작 불가능 (보안)

**사용 위치**:
- `js/push_notification.js` → `savePushTokenToGnuboard()` 함수

---

##### 2️⃣ 앱 브리지 콜백 함수 추가

**위치**: 라인 194-215
**작업**: `onTokenReceived()` 함수 추가

```javascript
// ✅ 추가된 함수
function onTokenReceived(token) {
    // 토큰이 없으면 종료
    if (!token) {
        console.warn('[앱 브리지] 토큰이 비어있습니다');
        return;
    }

    console.log('[앱 브리지] FCM Token 수신:', token.substring(0, 20) + '...');

    // push_notification.js의 receiveFCMToken() 함수 호출
    if (window.receiveFCMToken) {
        console.log('[앱 브리지] receiveFCMToken() 함수 호출');
        window.receiveFCMToken(token);
    } else {
        // receiveFCMToken이 아직 로드되지 않은 경우
        console.warn('[앱 브리지] receiveFCMToken 함수 아직 로드 안됨');
        console.warn('[앱 브리지] localStorage에만 임시 저장');
        localStorage.setItem('fcm_token', token);
    }
}
```

**목적**:
- Android/iOS 네이티브 앱 → 웹뷰 공통 콜백 함수
- 네이티브에서 전달받은 FCM 토큰을 웹뷰에서 처리

**작동 방식**:
1. Android: `Android.requestToken()` 호출 → `onTokenReceived()` 콜백
2. iOS: `webkit.messageHandlers.invokeAction.postMessage('getToken')` 호출 → `onTokenReceived()` 콜백
3. 웹뷰: 받은 토큰을 `receiveFCMToken()`에 전달하여 서버 저장

**파라미터**:
- `token` (string): FCM 토큰 (152자 이상의 문자열)

**에러 처리**:
- 토큰이 없으면 경고 로그 후 종료
- `receiveFCMToken()` 함수가 없으면 localStorage에만 임시 저장

---

##### 3️⃣ DOMContentLoaded 이벤트 핸들러 추가

**위치**: 라인 225-272
**작업**: 페이지 로드 시 네이티브 앱에 토큰 요청

```javascript
// ✅ 추가된 이벤트 리스너
document.addEventListener('DOMContentLoaded', function () {
    console.log('[앱 브리지] DOMContentLoaded - 네이티브 앱 토큰 요청 시작');

    // Android 브리지 확인 및 토큰 요청
    if (window.Android && typeof Android.requestToken === 'function') {
        console.log('[앱 브리지] ✅ Android 브리지 감지됨');
        console.log('[앱 브리지] Android.requestToken() 호출');

        try {
            Android.requestToken();  // 네이티브에 토큰 요청
        } catch (e) {
            console.error('[앱 브리지] Android.requestToken() 호출 실패:', e);
        }
    } else {
        console.log('[앱 브리지] ❌ Android 브리지 없음');
    }

    // iOS 브리지 확인 및 토큰 요청
    if (
        window.webkit &&
        window.webkit.messageHandlers &&
        window.webkit.messageHandlers.invokeAction
    ) {
        console.log('[앱 브리지] ✅ iOS 브리지 감지됨');
        console.log('[앱 브리지] webkit.messageHandlers.invokeAction.postMessage("getToken") 호출');

        try {
            window.webkit.messageHandlers.invokeAction.postMessage('getToken');
        } catch (e) {
            console.error('[앱 브리지] iOS 토큰 요청 실패:', e);
        }
    } else {
        console.log('[앱 브리지] ❌ iOS 브리지 없음');
    }

    // 웹 브라우저 감지
    if (!window.Android && !window.webkit) {
        console.log('[앱 브리지] 💻 웹 브라우저에서 접속 (네이티브 앱 아님)');
    }
});
```

**목적**:
- DOM 로드 완료 후 자동으로 네이티브 앱에 FCM 토큰 요청
- Android와 iOS 브리지 존재 여부를 확인하여 분기 처리

**Android 브리지 감지**:
- `window.Android` 객체 존재 확인
- `Android.requestToken` 함수 존재 확인
- 있으면 `Android.requestToken()` 호출

**iOS 브리지 감지**:
- `window.webkit.messageHandlers.invokeAction` 존재 확인
- 있으면 `postMessage('getToken')` 호출

**웹 브라우저**:
- 브리지가 둘 다 없으면 웹 브라우저로 판단
- 아무 동작 하지 않음 (정상)

**에러 처리**:
- try-catch로 감싸서 호출 실패 시 에러 로그 출력

---

#### 📊 추가된 코드 통계

| 항목 | 라인 수 | 설명 |
|------|---------|------|
| **주석** | 35줄 | 상세한 설명 및 JSDoc 주석 |
| **코드** | 78줄 | 실제 JavaScript 코드 |
| **전역 변수** | 1개 | `g5_member_id` |
| **함수** | 1개 | `onTokenReceived()` |
| **이벤트 리스너** | 1개 | `DOMContentLoaded` |
| **총계** | 113줄 | 주석 + 코드 |

---

#### 🔗 연관 파일

1. **js/push_notification.js**
   - `receiveFCMToken(token)` 함수와 연동
   - `savePushTokenToGnuboard(token)` 함수에서 `g5_member_id` 사용

2. **bbs/ajax.push_token.php**
   - 서버 측 토큰 저장 API
   - `$member['mb_id']`로 세션에서 회원 ID 추출

3. **알림_기존_세팅분석및방법.md**
   - 전체 구현 가이드 문서
   - Step 1, 2, 3 작업 순서 명시

---

#### ✅ 작업 완료 체크리스트

- [x] `g5_member_id` 전역 변수 추가
- [x] `onTokenReceived()` 콜백 함수 추가
- [x] DOMContentLoaded 이벤트 리스너 추가
- [x] Android 브리지 감지 코드 추가
- [x] iOS 브리지 감지 코드 추가
- [x] 에러 처리 (try-catch) 추가
- [x] 상세 주석 작성 (JSDoc 포함)
- [x] 콘솔 로그 추가 (디버깅용)

---

#### 🧪 테스트 필요 사항

##### Android 앱 테스트
1. WebView에서 페이지 로드 확인
2. 콘솔 로그 확인: `[앱 브리지] ✅ Android 브리지 감지됨`
3. `Android.requestToken()` 호출 확인
4. `onTokenReceived()` 콜백 수신 확인
5. `receiveFCMToken()` 함수 호출 확인
6. 서버에 토큰 저장 확인 (ajax.push_token.php)
7. DB 확인: `g5_push_tokens` 테이블에 토큰 저장됨

##### iOS 앱 테스트
1. WKWebView에서 페이지 로드 확인
2. 콘솔 로그 확인: `[앱 브리지] ✅ iOS 브리지 감지됨`
3. `webkit.messageHandlers.invokeAction.postMessage('getToken')` 호출 확인
4. `onTokenReceived()` 콜백 수신 확인
5. `receiveFCMToken()` 함수 호출 확인
6. 서버에 토큰 저장 확인 (ajax.push_token.php)
7. DB 확인: `g5_push_tokens` 테이블에 토큰 저장됨

##### 웹 브라우저 테스트
1. 페이지 로드 확인
2. 콘솔 로그 확인: `[앱 브리지] 💻 웹 브라우저에서 접속`
3. 에러 없이 정상 동작 확인

---

#### 📌 주의사항

1. **토큰 형식**
   - FCM 토큰은 152자 이상의 문자열
   - 빈 문자열이나 null 체크 필수

2. **로그인 상태**
   - `g5_member_id`는 로그인 시에만 값 존재
   - 비로그인 상태에서는 빈 문자열 (`""`)

3. **스크립트 로드 순서**
   - `push_notification.js`가 먼저 로드되어야 함
   - `head.sub.php` 라인 38에서 이미 로드 중
   - `receiveFCMToken()` 함수가 정의되어 있어야 함

4. **보안**
   - `g5_member_id`는 서버 세션에서 추출
   - 클라이언트에서 조작 불가능
   - XSS 방지를 위해 특수문자 이스케이프 처리됨

---

#### 🔍 디버깅 팁

##### 콘솔 로그 확인 방법

**Android (Chrome DevTools)**:
1. PC에서 Chrome 열기
2. `chrome://inspect` 접속
3. 연결된 Android 기기의 WebView 선택
4. Console 탭에서 로그 확인

**iOS (Safari Web Inspector)**:
1. Mac에서 Safari 열기
2. 개발자 메뉴 → iPhone/iPad 선택
3. 웹뷰 선택
4. Console 탭에서 로그 확인

**예상 로그 순서**:
```
[앱 브리지] DOMContentLoaded - 네이티브 앱 토큰 요청 시작
[앱 브리지] ✅ Android 브리지 감지됨
[앱 브리지] Android.requestToken() 호출
[앱 브리지] FCM Token 수신: dXYz1234567890abcdef...
[앱 브리지] receiveFCMToken() 함수 호출
FCM Token received: dXYz1234567890abcdefg...  // push_notification.js
토큰 저장 성공  // push_notification.js
```

---

## 📋 다음 작업 예정

### Step 2: Android 앱 구현 (예정)
- [ ] MainActivity.kt에 WebView 설정
- [ ] JavaScript Interface 추가
- [ ] FCM 토큰 가져오기
- [ ] `onTokenReceived()` 호출 구현

### Step 3: iOS 앱 구현 (예정)
- [ ] ViewController.swift에 WKWebView 설정
- [ ] WKScriptMessageHandler 구현
- [ ] FCM 토큰 가져오기
- [ ] `onTokenReceived()` 호출 구현

---

## 📚 참고 문서

- **알림_기존_세팅분석및방법.md**: 전체 구현 가이드
- **로그인시_토큰저장_문제점_및_해결방법.md**: 문제 해결 과정 (참고용)
- **알림_함수_호출방법.md**: API 호출 방법
- **new_http_v1_mars/api_docs.php**: API 문서 HTML 페이지

---

## 🛠️ 파일 변경 이력

| 날짜 | 파일 | 변경 내용 | 작업자 |
|------|------|-----------|--------|
| 2025-01-03 | theme/rb.basic/head.sub.php | 앱 브리지 코드 추가 (113줄) | Claude |

---

**작업 완료 시각**: 2025-01-03 15:30
**작업 소요 시간**: 약 15분
**작업 난이도**: ⭐⭐⭐ (중)
